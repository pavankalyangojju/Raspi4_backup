import cv2
import easyocr
import RPi.GPIO as GPIO
import time
from datetime import datetime
from mfrc522 import SimpleMFRC522

# ---------------- Motor Setup ----------------
motor1_in1 = 21
motor1_in2 = 20
motor2_in1 = 16
motor2_in2 = 12
motor1_en = 5
motor2_en = 6

GPIO.setmode(GPIO.BCM)
GPIO.setup([motor1_in1, motor1_in2, motor2_in1, motor2_in2, motor1_en, motor2_en], GPIO.OUT)
GPIO.output(motor1_en, GPIO.HIGH)
GPIO.output(motor2_en, GPIO.HIGH)

def move_forward():
    GPIO.output(motor1_in1, GPIO.HIGH)
    GPIO.output(motor1_in2, GPIO.LOW)
    GPIO.output(motor2_in1, GPIO.HIGH)
    GPIO.output(motor2_in2, GPIO.LOW)
    print("Moving forward...")

def move_backward():
    GPIO.output(motor1_in1, GPIO.LOW)
    GPIO.output(motor1_in2, GPIO.HIGH)
    GPIO.output(motor2_in1, GPIO.LOW)
    GPIO.output(motor2_in2, GPIO.HIGH)
    print("Moving backward...")

def stop_motors():
    GPIO.output(motor1_in1, GPIO.LOW)
    GPIO.output(motor1_in2, GPIO.LOW)
    GPIO.output(motor2_in1, GPIO.LOW)
    GPIO.output(motor2_in2, GPIO.LOW)
    print("Motors stopped.")

# ---------------- Ultrasonic Setup ----------------
GPIO_TRIGGER = 23
GPIO_ECHO = 24
GPIO.setup(GPIO_TRIGGER, GPIO.OUT)
GPIO.setup(GPIO_ECHO, GPIO.IN)

def distance():
    GPIO.output(GPIO_TRIGGER, True)
    time.sleep(0.00001)
    GPIO.output(GPIO_TRIGGER, False)

    start_time = time.time()
    stop_time = time.time()

    while GPIO.input(GPIO_ECHO) == 0:
        start_time = time.time()

    while GPIO.input(GPIO_ECHO) == 1:
        stop_time = time.time()

    elapsed = stop_time - start_time
    dist = (elapsed * 34300) / 2
    return dist

def move_until_object(threshold=5.0):
    start = time.time()
    move_forward()
    while True:
        d = distance()
        print(f"Distance: {d:.2f} cm")
        if d <= threshold:
            stop_motors()
            forward_time = time.time() - start
            print("Object detected within 5 cm.")
            return forward_time
        time.sleep(0.05)

# ---------------- Servo Setup ----------------
servo_index_pin = 18
servo_door_pin = 25
GPIO.setup(servo_index_pin, GPIO.OUT)
GPIO.setup(servo_door_pin, GPIO.OUT)
servo_index = GPIO.PWM(servo_index_pin, 50)
servo_door = GPIO.PWM(servo_door_pin, 50)
servo_index.start(0)
servo_door.start(0)

positions = {1: 0, 2: 80, 3: 160}  # index positions

def angle_to_duty(angle):
    return angle / 18 + 2.5

def set_servo(servo_pwm, angle, hold=0.5):
    duty = angle_to_duty(angle)
    servo_pwm.ChangeDutyCycle(duty)
    time.sleep(hold)
    servo_pwm.ChangeDutyCycle(0)

def dispense_tablet(tag):
    now = datetime.now()
    hour = now.hour
    # Example: choose slot based on time
    if 6 <= hour < 12:
        part = 1
    elif 12 <= hour < 18:
        part = 2
    else:
        part = 3

    print(f"Dispensing tablet for tag {tag} at {now.strftime('%H:%M')}")
    set_servo(servo_index, positions[part])
    print("Opening door...")
    set_servo(servo_door, 90)
    time.sleep(2)
    print("Closing door...")
    set_servo(servo_door, 0)

# ---------------- RFID Setup ----------------
reader_rfid = SimpleMFRC522()

def read_rfid():
    print("Place your RFID card near the reader...")
    id, text = reader_rfid.read()
    print(f"Card ID: {id}, Data: {text}")
    return text.strip()

# ---------------- OCR Setup ----------------
reader = easyocr.Reader(['en'])
cap = cv2.VideoCapture(0)
frame_count = 0

# ---------------- Main Flow ----------------
try:
    while True:
        ret, frame = cap.read()
        if not ret:
            break

        frame_count += 1
        if frame_count % 10 == 0:
            results = reader.readtext(frame)
            for (_, text, prob) in results:
                digits = ''.join([c for c in text if c.isdigit()])
                if digits == "2":
                    print("Digit '2' detected!")
                    forward_time = move_until_object(threshold=5.0)
                    tag = read_rfid()
                    dispense_tablet(tag)
                    print("Returning to original position...")
                    move_backward()
                    time.sleep(forward_time)
                    stop_motors()
                    print("Process complete.")
                    raise KeyboardInterrupt  # exit after one cycle

except KeyboardInterrupt:
    print("Stopped by user")

finally:
    cap.release()
    servo_index.stop()
    servo_door.stop()
    GPIO.cleanup()
    print("GPIO cleaned up.")
